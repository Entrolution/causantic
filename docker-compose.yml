version: '3.8'

services:
  causantic:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: causantic
    volumes:
      # Persist memory data
      - causantic-data:/data/causantic
      # Mount Claude projects for ingestion (read-only)
      - ~/.claude/projects:/claude-projects:ro
    environment:
      - CAUSANTIC_STORAGE_DB_PATH=/data/causantic/memory.db
      - CAUSANTIC_STORAGE_VECTOR_PATH=/data/causantic/vectors
      # Optional: Anthropic API key for cluster label refresh
      # - CAUSANTIC_ANTHROPIC_KEY=${CAUSANTIC_ANTHROPIC_KEY}
    ports:
      # HTTP port for web dashboard (when implemented)
      - "3000:3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('./dist/storage/db.js').getDatabase().prepare('SELECT 1').get()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Maintenance daemon (runs scheduled tasks)
  causantic-maintenance:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: causantic-maintenance
    volumes:
      - causantic-data:/data/causantic
      - ~/.claude/projects:/claude-projects:ro
    environment:
      - CAUSANTIC_STORAGE_DB_PATH=/data/causantic/memory.db
      - CAUSANTIC_STORAGE_VECTOR_PATH=/data/causantic/vectors
    command: ["node", "dist/cli/index.js", "maintenance", "daemon"]
    restart: unless-stopped
    depends_on:
      - causantic

volumes:
  causantic-data:
    driver: local
